# Bug Fix Plan: PME-484256 - Unable to Apply Reservation to Unit when Quote Expired but Reservation Valid

## Bug Analysis

### How to Reproduce the Bug:
1. **Setup:**
   - Create an applicant in New OneSite 
   - Generate a quote for a specific unit (e.g., apartment #644)
   - Put the apartment in reserve status within the 48-hour quote window
   - Allow the quote to expire (after 48 hours) while keeping the reservation active

2. **Reproduction Steps:**
   - Log into New OneSite
   - Navigate to the applicant record (e.g., Shanell Paraison)
   - Go to the Quotes section
   - Look for the expired quote with active reservation
   - Click on the eclipse dropdown menu for the reservation
   - Observe that "Select Unit" option is missing/disabled
   - Compare with Classic OneSite where this option is available

3. **Expected vs Actual Behavior:**
   - **Expected (Classic OneSite):** "Select Unit" option available under reservation dropdown even when quote is expired but reservation is still valid (within 48-hour reservation window)
   - **Actual (New OneSite):** "Select Unit" option is not available/disabled when quote is expired, regardless of reservation validity

### How to Debug It:
1. **Set Breakpoints:**
   - `RealPage\OneSite\Applicants\Realpage.OneSite.Applicants\BusinessLogic\Class\CommitUnitManager.cs` line 82: `ValidateApplicantCommitUnit` method
   - `RealPage\OneSite\Applicants\Realpage.OneSite.Applicants\DAO\Class\CommitUnitDAO.cs` line 124: `UnitDetailSelect` method
   - Quote validation logic in UnifiedQuotes controller

2. **Variables to Inspect:**
   - `commitUnit.UnitID` and `commitUnit.LeaseID`
   - Quote expiration timestamp vs current time
   - Reservation expiration timestamp vs current time
   - Unit availability bit (`UNITAVAILABLEBIT = 11`)
   - Quote status and reservation status flags

3. **Log Statements Needed:**
   - Add logging in `ValidateApplicantCommitUnit` to track quote vs reservation validation
   - Log the results of `UnitDetailSelect` stored procedure
   - Add logs in quote/reservation dropdown population logic

4. **Execution Flow Tracing:**
   - UI dropdown population ? API call ? Business Logic validation ? DAO query ? Database stored procedure
   - Focus on where quote expiry check blocks reservation-based unit selection

### Why the Bug is Occurring:

**Root Cause Analysis:**

The issue stems from a **business logic discrepancy** between Classic OneSite and New OneSite in how they handle the relationship between quotes and reservations:

1. **Classic OneSite Logic:** 
   - Treats quotes and reservations as separate entities with independent expiration timelines
   - Allows unit selection based on valid reservation even if the associated quote has expired
   - Recognizes that reservation creates a new 48-hour window independent of quote expiration

2. **New OneSite Logic:**
   - Has "hardcoded" business logic that tightly couples quotes and reservations
   - Validation in `CommitUnitManager.ValidateApplicantCommitUnit()` likely checks quote validity before allowing unit selection
   - The `UnitDetailSelect` stored procedure may be filtering out units with expired quotes regardless of reservation status

**Specific Code Issues:**

1. **Primary Issue:** In `CommitUnitManager.cs`, the validation logic in `ValidateApplicantCommitUnit()` method doesn't distinguish between quote expiration and reservation validity
2. **Secondary Issue:** The UI dropdown population logic doesn't check for valid reservations independently of quote status
3. **Data Layer Issue:** The `UnitDetailSelect` stored procedure may not properly handle the scenario where quote is expired but reservation is valid

### How to Fix It:

**Solution Approach:**
Modify the validation logic to check reservation validity independently from quote expiration, matching Classic OneSite behavior.

**Primary Fix - Update CommitUnitManager Validation:**

File: `RealPage\OneSite\Applicants\Realpage.OneSite.Applicants\BusinessLogic\Class\CommitUnitManager.cs`

1. **Add new validation method:**
```csharp
private bool IsReservationValid(SqlTransaction trans, CommitUnit commitUnit)
{
    // Check if reservation exists and is still valid (within 48 hour window)
    return _dao.CheckReservationValidity(trans, commitUnit.LeaseID, commitUnit.UnitID);
}
```

2. **Modify `ValidateApplicantCommitUnit` method (around line 285):**

**Before:**
```csharp
if (!_dao.UnitDetailSelect(trans, commitUnit.UnitID))
{
    AddApiError("The 'Commit unit' action may not be performed until the unit becomes available.");
    return false;
}
```

**After:**
```csharp
// Check unit availability OR valid reservation
bool unitAvailable = _dao.UnitDetailSelect(trans, commitUnit.UnitID);
bool reservationValid = IsReservationValid(trans, commitUnit);

if (!unitAvailable && !reservationValid)
{
    AddApiError("The 'Commit unit' action may not be performed until the unit becomes available or a valid reservation exists.");
    return false;
}

// If unit not available but reservation is valid, allow the action
if (!unitAvailable && reservationValid)
{
    // Log that we're proceeding with reservation-based selection
    // This matches Classic OneSite behavior
}
```

**Secondary Fix - Add DAO Method for Reservation Validation:**

File: `RealPage\OneSite\Applicants\Realpage.OneSite.Applicants\DAO\Class\CommitUnitDAO.cs`

1. **Add new method:**
```csharp
public bool CheckReservationValidity(SqlTransaction trans, int leaseId, int unitId)
{
    if (trans == null)
    {
        throw new ArgumentException("CommitUnit - CheckReservationValidity trans parameter cannot be null");
    }

    bool result = false;
    Hashtable parameters = new Hashtable();
    SetStandardParameters(parameters);
    parameters.Add("@IPVC_LEASEID", leaseId);
    parameters.Add("@IPVC_UNITID", unitId);

    const int RESERVATION_VALID = 0;

    string query = _db.CheckReservationValiditySelect;
    using (SqlDataReader reader = ExecuteSqlDataReader(query, parameters, trans.Connection, trans))
    {
        if (reader.Read())
        {
            result = ReaderUtility.ToInt32(reader, RESERVATION_VALID) == 1;
        }
    }
    return result;
}
```

**Tertiary Fix - Add DB Object for Reservation Check:**

File: `RealPage\OneSite\Applicants\Realpage.OneSite.Applicants\DBObjects\Class\CommitUnitDB.cs`

1. **Add new stored procedure call:**
```csharp
public string CheckReservationValiditySelect
{
    get
    {
        string query = @"
        SET NOCOUNT ON

        EXEC [dbo].[uspCheckReservationValidity]
            @InternalEntityID = @InternalEntityID
            ,@InternalUserID  = @InternalUserID
            ,@InternalSiteID  = @InternalSiteID
            ,@IPVC_LEASEID = @IPVC_LEASEID
            ,@IPVC_UNITID = @IPVC_UNITID
        ";
        return query;
    }
}
```

**Database Changes Required:**

Create new stored procedure `uspCheckReservationValidity` that:
1. Checks if a reservation exists for the given lease/unit combination
2. Validates that the reservation is within the 48-hour window
3. Returns 1 if valid reservation exists, 0 otherwise

**UI Changes (if needed):**

The dropdown population logic may also need updates to show "Select Unit" option when reservation is valid, even if quote is expired.

### How to Test It:

**Manual Testing Steps:**
1. **Setup Test Data:**
   - Create test applicant
   - Generate quote for specific unit
   - Create reservation within 48-hour quote window
   - Wait for quote to expire (or set system date forward)

2. **Test Valid Reservation Scenario:**
   - Verify reservation is still within 48-hour window
   - Navigate to applicant in New OneSite
   - Check that "Select Unit" option appears under reservation dropdown
   - Attempt to commit unit using reservation
   - Verify success

3. **Test Expired Reservation Scenario:**
   - Set system date beyond reservation expiry
   - Verify "Select Unit" option is NOT available
   - Ensure proper error messaging

**Edge Cases to Verify:**
1. **Boundary Testing:** Test exactly at 48-hour mark for both quote and reservation expiry
2. **Multiple Reservations:** Test with multiple units reserved by same applicant
3. **Unit Availability Changes:** Test when unit becomes unavailable after reservation created
4. **Concurrent Access:** Test multiple users accessing same unit reservation

**Regression Testing:**
1. Verify normal quote-based unit selection still works
2. Ensure unit availability checks still function correctly
3. Test that expired quotes without valid reservations are properly blocked
4. Verify Classic OneSite behavior remains unchanged

### Potential Risks and Side Effects:

**Risks:**
1. **Data Integrity:** Allowing unit commitment with expired quotes might affect reporting
2. **Business Logic Changes:** May impact other areas that depend on strict quote validation
3. **Audit Trail:** Need to ensure proper logging of reservation-based vs quote-based selections

**Mitigation:**
1. Add comprehensive logging for reservation-based unit selections
2. Update audit trails to distinguish between quote-based and reservation-based commits
3. Consider adding feature flag to enable/disable new behavior during rollout
4. Thorough testing in staging environment with realistic data volumes

**Dependencies:**
- May require database schema changes for reservation validity tracking
- Could impact integration points that expect quote-based validation
- UI updates might be needed across multiple components

**Related Areas That Might Be Affected:**
- Reporting systems that track quote-to-lease conversion rates
- Integration with external systems that sync quote/reservation data  
- Mobile applications that might have similar validation logic
- APIs used by third-party integrations
